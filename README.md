# steering_rl78
操舵系マイコンのファームウェア

---
## Pin Assignment
- P1.6 RXD0 (サーボ用)
- P1.7 TXD0 (サーボ用)
- P2.2 ANI2
- P2.3 ANI3
- P3.0 GPIO (LED Red)
- P4.0 1-wire programmer 兼 デバッグ用シリアル
- P5.0 GPIO (LED Green)
- P5.1 GPIO (LED Blue)

---
## デバッグ用シリアル通信

USBでPCと接続をすると，内部のFT231Xを経由してマイコンとシリアル通信を行える．<br>
通信時のbaud rateは 9600 bps に設定する．フロー制御は行わない．<br>
半二重通信であるため，マイコンが出力を行っている際に入力を行うと無視される．<br>
 **PC接続時は，制御基板上のバッテリを取り外すこと．** USB経由でPCへ電流が逆流する可能性があるため．

---
## コマンド

| コマンド名 | 説明 |
| :-------- | :--- |
| help | コマンド一覧を表示する |
| clear | ターミナルの表示を消去する |
| reset | マイコンにリセットをかける |
| resf | リセット要因を表示する |
| load | Flash ROMから設定を読み込む |
| save | Flash ROMへ設定を書き込む |
| hedefault_config | 初期設定を読み込む |
| led | LEDを操作する |
| ad | AD変換結果とサーボの指令値を表示する |
| control | サーボ制御の開始/停止を行う |
| servo | サーボを指定位置に動かす |
| set | サーボの設定を変更する |
| write_id | サーボにIDを書き込む |
| show | サーボの設定を表示する |

---
### help
```
help
```

コマンド一覧を表示する．

---
### clear
```
clear
```

ターミナルの表示を消去する．

---
### reset
```
reset
```

マイコンにリセットをかける．

---
### resf
```
resf
```

リセット要因を表示する．<br>
ただし，リセット要因はリセット後1回しか表示することができず，また初期化時に呼び出すため，手動で呼び出す意味はない．

---
### load
```
load [BLOCK]
```

Flash ROMから設定を読み込む．<br>
指定されたブロックに設定が書き込まれていない場合は読み出しに失敗し，失敗した要因に合わせて0以外の戻り値を返す．

引数`BLOCK`は0以上のブロック番号．<br>
ファームウェア起動時には第0ブロックから設定を読み出す．<br>
引数`BLOCK`を省略した場合，0を指定されたものとみなす．

---
### save
```
save [BLOCK]
```

Flash ROMへ設定を書き込む．<br>
`set`コマンドまたは`default_config`コマンドにより設定を変更し，その設定を次回以降の起動時にも使用したい場合は本コマンドにより設定を保存する．

引数`BLOCK`は0以上のブロック番号．<br>
ファームウェア起動時には第0ブロックから設定を読み出す．<br>
引数`BLOCK`を省略した場合，0を指定されたものとみなす．

---
### default_config
```
default_config
```

ソースコードに記述された初期設定を読み込む．<br>
ファームウェア起動時に第0ブロックに有効な設定が保存されていない場合，自動で呼び出される．<br>

---
### led
```
led PATTERN
```

LEDを操作する．<br>
引数`PATTERN`は0から7までの数字を指定できる．<br>
引数`PATTERN`は2bit目が赤(P3.0)，1bit目が緑(P5.0)，0bit目が青(P5.1)に対応し，対応するbitが1の場合にLEDが点灯する．

---
### ad
```
ad
```

最後のAD変換結果と最後のサーボの指令値を表示する．

---
### control
```
control BOOL
```

サーボ制御の開始/停止を行う．<br>
引数`BOOL`が0の場合，AD変換割り込み用タイマを停止し，サーボの制御指令送信が停止する．<br>
引数`BOOL`が1の場合，AD変換割り込み用タイマを開始し，サーボの制御指令送信が開始する．

---
### servo
```
servo ID POS
```

サーボを指定位置に動かす．<br>
引数`ID`はサーボのIDを指定する．(現在は0, 1が使用されている) <br>
引数`POS`はサーボの角度を0～1023の範囲で指定する．512を指定すると中央となる．<br>

---
### set
```
set ID ITEM VALUE
```

サーボの設定を変更する．<br>
引数`ID`はサーボのIDを指定する．(現在は0, 1が使用されている) <br>
引数`ITEM`は設定項目であり，offset, rot_count, invert, trim, range, limit_upper, limit_lowerのうち一つを指定する．<br>
引数`VALUE`は，指定したサーボIDの設定項目に対して設定する値を整数で指定する．<br>

設定項目と設定値の範囲は以下に記載する．<br>

| `ITEM` | 項目の意味 | `VALUE`の範囲 | デフォルト |
| :----- | :-------- | :------------ | :-------- |
| offset | サーボの動作範囲の中央値のサーボ指令値 | 0～16383 | 7500 |
| rot_count | サーボが一回転するためのサーボ指令値の幅 | 0～16383 | 10666 |
| invert | サーボの回転方向を反転する (offsetを中心とする) | 0～1 | N/A |
| trim | トリム角度を0.01°単位で指定する (ex: 0.01° = 1, 0.10° = 10) | -18000～+18000| N/A |
| range | 操作範囲を0.01°単位で指定する．<br>(ex: 120.00°を指定した場合，トリム位置から±60.00°の範囲で動作する | 0～+32767 | 12000 |
| limit_upper | サーボの動作範囲の上限を0.01°単位で指定する． (offsetを中心とする) | -18000～+18000 | N/A |
| limit_lower | サーボの動作範囲の下限を0.01°単位で指定する． (offsetを中心とする) | -18000～+18000 | N/A |

注意事項

- 単位の間違いに注意
    - offset, rot_countはサーボに送信される指令値で指定する
    - trim, range, limit_upper, limit_upperはサーボの角度を0.01°単位で指定する．
- サーボホーンを取り付けなおした場合，limit_upper, limit_lowerの範囲を再調整する．

---
### write_id
```
write_id ID
```

 **接続されているすべてのサーボに対して**指定したIDを書き込む．<br>
引数`ID`は書き込まれるIDを指定する．<br>

---
### show
```
show
```

現在の設定を表示する．
